# 웹에서 자바스크립트의 실행 과정

크롬의 자바스크립트 엔진인 v8을 기준으로 자바스크립트 실행 과정.
웹에서 자바스크립트 코드가 v8엔진에게 전달되면, 엔진은 소스코드를 읽고 파서를 통해 코드를 `AST`로 변환한다.

```text
파싱 -> Bytecode 생성 -> 실행
```

## Parsing

### Pre-Parsing

코드를 전부 파싱하기 이전에 미리 간단하게 분석하여 중요한 구문적 오류나 변수 선언같은 기초적인 정보를 확인한다.

### Full Parsing

준비가 끝나면, 전체 파싱을 통해 AST(Abstract Syntax Tree)를 만든다.
Abstract Syntx Tree: 코드의 구조를 트리형태로 표현한것으로 코드 최적화와 실행에 사용된다.

### Lazy Pargins

v8엔진은 전체 코드를 즉시 파싱하지 않고, 실행에 필요한 부분만 우선적으로 파싱한다. 함수가 처음 선언되었을 때 전부 파싱하지 않고, 해당 함수가 호출될 때에야 파싱을 수행한다.

## Bytecode 생성

AST가 생성되면, 엔진의 인터프리터가 바이트코드를 생성한다. 바이트코드는 중간 단계의 저수준 코드로, 이를 통해 v8엔진은 자바스크립트를 바로 실행할 수 있다.

## 실행

바이트코드로 변환된 후 인터프리터에 의해 실행된다. 이 과정에서 엔진은 실행 패턴을 모니터링하며, 자주 실행되거나 최적화할 수 있는 코드를 발견하면 **JIT컴파일러**를 사용해 최적화를 적용한다.

### Just-In-Time 컴파일러

프로그램 실행 중에 코드를 실시간으로 컴파일해 성능을 최적화 하는 기술로 기본적으로 인터프리터와 AOT(Ahead-of-Time)컴파일러의 장점을 결합한 방식이다. 인터프리터는 코드를 한 줄씩 읽고 즉기 실행하는 방식이고, AOT는 프로그램이 실행되기 전에 전체 코드를 기계어로 변환하는 방식이다.

```text
컴파일러의 동작 과정

1. 인터프리팅 시작 -> 2. 프로파일링 (자주 사용되는 함수, 루프, 데이터 타입등을 추적한다) -> 3. JIT 컴파일 -> 4. 최적화된 코드 실행 -> 5. 디옵티마이제이션
```

## 가비지 콜렉션

엔진은 메모리 관리를 위해 가비지 컬렉터를 실행한다.자바스크립트는 명시적인 메모리 해제 과정 없이도 엔진이 자동으로 사용되지 않는 메모리를 회수한다.

## 인라인 캐싱

함수 호출 및 프로퍼티의 접근을 최적화하기 위해 인라인 캐싱을 사용한다. 인라인 캐싱은 객체의 프로퍼티 접근 시, 자주 사용되는 객체의 구조를 미리 기록해 두어 이후 접근 시 더 빠르게 처리할 수 있도록 도와준다.

## 최적화

엔진은 실행 중 예기치 않은 타입 변환이나 조건이 발생하면 최적화된 코드를 `deoptimize`한다. 이때 최적화된 코드를 폐기하고, 다시 인터프리터 모드로 돌아가거나 재컴파일을 수행한다.

---

파이어폭스는 v8과 유사한 과정을 거치지만, 독자적인 컴파일러인 IonMonkey를 사용하고, 사파리는 다단계 JIT컴파일 과정을 거치며 점진적으로 코드를 최적화한다. 엣지는 현재 크롬 v8엔진을 사용하므로 실행과정은 거의 동일한다.

---

## 자바스크립트를 최적화 할 수 있는 몇가지 방법

- [Code Splitting](react/code-splitting) : 애플리케이션 번들을 여러개의 작은 청크로 분할
- Tree Shaking : 번들에서 사용하지 않는 코드를 제거
- Module : 코드를 모듈화를 통해 구조화 및 최적화
- WebAssembly (Wasm) : 네이티브에 가까운 저수준 바이너리 포맷
- Async, Event Loop 최적화 : 비동기 처리와 이벤트 루프를 최적화
